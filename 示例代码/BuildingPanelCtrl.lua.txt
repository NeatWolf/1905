--建筑面板控制器
BuildingPanelCtrl = {}

--总加成
goldBuff = 0
girlJuiceBuff = 0

--建筑系数、好感系数
local buildingValue = 1.15
local favorableValue = 1.6

--top内含金币、妹汁Text组件
local top = {}

--Items内涵所有建筑上的组件，key为建筑ID，值内含button、buildingName、level、favorable、gold、girlJuice、need
local items = {}

--初始化建筑名称、建筑升级消耗、建筑等级
function BuildingPanelCtrl:Init()
    local parent =
        CS.UnityEngine.GameObject.Find('UI/Canvas_Bar/3DPanel/BuildingPanel/Scroll View/Viewport/Content').transform
    top['gold'] = parent:Find('Top'):Find('Gold'):GetComponent('Text')
    top['girlJuice'] = parent:Find('Top'):Find('GirlJuice'):GetComponent('Text')

    for i = 0, #FinalData.building - 1 do
        -- 初始化Items
        items[i] = parent:Find(i .. ''):GetComponent('BuildingItemView')
    end

    --显示名称
    for ID, item in pairs(items) do
        item.buildingName.text = FinalData.building[ID + 1].name
    end
end

--刷新建筑加成数据显示 -每次点击升级按钮
function BuildingPanelCtrl:DisplayBuildingData()
    girlJuiceBuff = 0
    goldBuff = 0
    -- 等级、加成、
    for ID, item in pairs(items) do
        item.level.text = FinalData.building[ID + 1].level .. '级'

        local gold = 'value'
        if FinalData.building[ID + 1].gold * FinalData.building[ID + 1].level > 0 then
            gold = '+' .. FinalData.building[ID + 1].gold * FinalData.building[ID + 1].level
        else
            gold = '' .. FinalData.building[ID + 1].gold * FinalData.building[ID + 1].level
        end
        item.gold.text = gold

        local girlJuice = 'value'
        if FinalData.building[ID + 1].girlJuice * FinalData.building[ID + 1].level > 0 then
            girlJuice = '+' .. FinalData.building[ID + 1].girlJuice * FinalData.building[ID + 1].level
        else
            girlJuice = '' .. FinalData.building[ID + 1].girlJuice * FinalData.building[ID + 1].level
        end
        item.girlJuice.text = girlJuice

        goldBuff = goldBuff + FinalData.building[ID + 1].gold * FinalData.building[ID + 1].level
        girlJuiceBuff = girlJuiceBuff + FinalData.building[ID + 1].girlJuice * FinalData.building[ID + 1].level
    end

    --总加成
    local goldStr = 'value'
    local girlJuiceStr = 'value'
    if goldBuff > 0 then
        goldStr = '+' .. goldBuff
    else
        goldStr = goldBuff
    end
    if girlJuiceBuff > 0 then
        girlJuiceStr = '+' .. girlJuiceBuff
    else
        girlJuiceStr = girlJuiceBuff
    end
    top.girlJuice.text = girlJuiceStr
    top.gold.text = goldStr

    --好感度显示
    items[0].favorable.text = '好感度：' .. (FinalData.favorable % 50 + 1) .. '/50'
end

--升级按钮刷新 -每秒
function BuildingPanelCtrl:DisplayBuildingButton()
    for ID, item in pairs(items) do
        if ID == 0 then
            --为爱发电,妹汁大于等于好感等级的favorableValue次方 * 需求 && 好感度 % 50 == 49
            if
                FinalData.girlJuice >= FinalData.building[1].level ^ favorableValue * FinalData.building[1].needGold and
                    FinalData.favorable % 50 == 49
             then
                item.button.interactable = true
            else
                item.button.interactable = false
            end
            local need = FinalData.building[1].level ^ favorableValue * FinalData.building[1].needGold
            local str = ('' .. need - need % 1)
            items[0].need.text = string.sub(str, 1, #str - 2)
        else
            --为爱发电之后,金币大于需求且好感等级大于需求
            if
                FinalData.gold >= FinalData.building[ID + 1].level ^ buildingValue * FinalData.building[ID + 1].needGold and --建筑系数
                    FinalData.building[1].level >= FinalData.building[ID + 1].needFavorable
             then
                item.button.interactable = true
            else
                item.button.interactable = false
            end
            local need = FinalData.building[ID + 1].level ^ buildingValue * FinalData.building[ID + 1].needGold --建筑系数

            local str = ('' .. need - need % 1)
            item.need.text = string.sub(str, 1, #str - 2)
        end
    end
end

--点击升级按钮
function BuildingPanelCtrl:Upgrade(gameObject)
    --根据名字对应的ID扣除资源增加等级
    if gameObject.name == '0' then
        -- 为爱发电
        FinalData.girlJuice =
            FinalData.girlJuice - FinalData.building[1].needGold * (FinalData.building[1].level ^ favorableValue)
        FinalData.building[1].level = FinalData.building[1].level + 1
        FinalData.favorable = FinalData.favorable + 1
        RoleDmcData.favorable = FinalData.favorable
        RoleDmcData.building[1].level = FinalData.building[1].level
    else
        local need =
            FinalData.building[gameObject.name + 1].needGold *
            (FinalData.building[gameObject.name + 1].level ^ buildingValue)
        FinalData.gold = FinalData.gold - need --建筑系数
        RoleDmcData.gold = FinalData.gold
        FinalData.building[gameObject.name + 1].level = FinalData.building[gameObject.name + 1].level + 1
        RoleDmcData.building[gameObject.name + 1].level = FinalData.building[gameObject.name + 1].level
    end
    --立即刷新数据显示
    self:DisplayBuildingButton()
    self:DisplayBuildingData()
    DataPanelCtrl:DisplayData()
end
