MakerCtrl = {}
-- 预制体上的UISubObject脚本，内含所有UI对象
MakerCtrl.Panel = nil
MakerCtrl.RoleWindow = nil

MakerCtrl.RightContent = nil

local Tag1 = "Food"
local Tag2 = "Item"
local Tag3 = "Equipment"

local SortWay1 = "Level"
local SortWay2 = "Price"

-- 记录筛选条件
MakerCtrl.Tag = Tag1
-- 记录排序条件
MakerCtrl.SortWay = SortWay1
MakerCtrl.ChangeWay = 1

-- 当前显示的所有道具
MakerCtrl.ItemsNow = nil
-- 当前选中的道具
MakerCtrl.ItemChoice = nil
-- 当前选择的英雄
MakerCtrl.HeroChoice = nil
-- 临时选择的英雄
MakerCtrl._heroChoiceTem = nil

function MakerCtrl:Init()
    print("进入制品手造")
    self.Panel = LoadManager:Load(ABManager:LoadAsset("prefab", "FabricateUI"), "UI", true):GetComponent("UISubObject")
    if (self.Panel == nil) then
        print("self.Panel == nil")
    end
    self.RightContent = CS.UnityEngine.GameObject.Find("Fabricate_Right/BG_List/FabricateList_Scroll/Viewport/Content")
    self:ShowItems()

    self.Panel.buttons[0].onClick:AddListener(
        function()
            self:ShowHeros()
        end
    )
    self.Panel.buttons[1].onClick:AddListener(
        function()
            self:SynItem()
        end
    )
    self.Panel.buttons[1].interactable = false

    self.Panel.toggles[0].onValueChanged:AddListener(
        function(isTrue)
            if isTrue == true then
                self.Tag = Tag1
                self.ItemChoice = nil
            end
            self:ShowItems()
        end
    )
    self.Panel.toggles[1].onValueChanged:AddListener(
        function(isTrue)
            if isTrue == true then
                self.Tag = Tag2
                self.ItemChoice = nil
            end
            self:ShowItems()
        end
    )
    self.Panel.toggles[2].onValueChanged:AddListener(
        function(isTrue)
            if isTrue == true then
                self.Tag = Tag3
                self.ItemChoice = nil
            end
            self:ShowItems()
        end
    )

    self.Panel.toggles[3].onValueChanged:AddListener(
        function(isTrue)
            if isTrue == true then
                self.ChangeWay = self.ChangeWay * (-1)
            else
                self.SortWay = SortWay1
                self.ChangeWay = 1
            end
            self:ShowItems()
        end
    )
    self.Panel.toggles[4].onValueChanged:AddListener(
        function(isTrue)
            if isTrue == true then
                self.ChangeWay = self.ChangeWay * (-1)
            else
                self.SortWay = SortWay2
                self.ChangeWay = 1
            end
            self:ShowItems()
        end
    )
end



-- 显示每一个英雄的框
function MakerCtrl:ShowHeroCells(_herosList)
    -- print("_herosList:" .. #_herosList)

    for k, v in pairs(_herosList) do

        -- print(_herosList[k].InsBuff)
        -- 分割字符串得到增益种类和加成
        local _buff = ModelTool:SplitStr(_herosList[k].InsBuff)

        -- 加载英雄Toggle的gameObject
        local _hero = LoadManager:Load(ABManager:LoadAsset("prefab", "Toggle_Role"), self.RoleWindow.go[0].transform, true)
        local _heroTog = _hero:GetComponent("Toggle")
        _heroTog.group = self.RoleWindow.go[0]:GetComponent("ToggleGroup")

        -- 添加英雄Toggle的点击事件
        _heroTog.onValueChanged:AddListener(
            function(isTrue)
                if isTrue == true then
                    self._heroChoiceTem = v
                    print("切换英雄成功：" .. self._heroChoiceTem.HeroID)
                else
                    _heroTog.isOn = false
                    _heroTog:OnDeselect()
                    self._heroChoiceTem = nil
                    print("取消英雄选择")
                end
            end
        )

        -- 显示英雄头像
        _hero.transform:Find("AV"):GetComponent("Image").sprite = ABManager:LoadAsset("texture", "female" , CS.UnityEngine.Sprite)
        -- 显示增益信息
        local _buffInfo = "增益類型:"
        if _buff[1] == "2" then
            _buffInfo = _buffInfo .. "食物"
        elseif _buff[1] == "3" then
            _buffInfo = _buffInfo .. "道具"
        else
            _buffInfo = _buffInfo .. "裝備"
        end
        _hero.transform:Find("Text (TMP)"):GetComponent("TextMeshProUGUI").text = _buffInfo .. "\n" .. _buff[2]

        -- 显示当前选中的英雄
        if self.HeroChoice ~=nil then
            self._heroChoiceTem = self.HeroChoice
            if v.HeroID == self._heroChoiceTem.HeroID then
                _heroTog.isOn = true
                _heroTog:Select()
            end
        end
        
    end
end

function MakerCtrl:ShowHeroChoice()
    -- self.Panel.images[0].sprite = ABManager:LoadAsset("texture", "self.HeroChoice.TexturePath" , CS.UnityEngine.Sprite)
    self.Panel.images[0].sprite = ABManager:LoadAsset("texture", "female" , CS.UnityEngine.Sprite)
end

-- 显示英雄选择界面
function MakerCtrl:ShowHeros()
    self._heroChoiceTem = self.HeroChoice
    -- 加载界面
    self.RoleWindow = LoadManager:Load(ABManager:LoadAsset("prefab", "FabricateUI_Role"), "FabricateUI", true):GetComponent("UISubObject")
    -- 删除所有子物体
    LoadManager:DeleteAllChilds(self.RoleWindow.go[0])
    -- 确认按钮
    self.RoleWindow.buttons[0].transform:Find("Text (TMP)"):GetComponent("TextMeshProUGUI").text = "確認"
    self.RoleWindow.buttons[0].onClick:AddListener(
        function()
            self.HeroChoice = self._heroChoiceTem
            self._heroChoiceTem = nil
            self:ShowHeroChoice()
            CS.UnityEngine.Object.Destroy(self.RoleWindow.gameObject)
            if self.HeroChoice ~= nil then
                print("选择英雄成功，当前所选择的英雄：" .. self.HeroChoice.HeroID)
            else
                print("当前未选择英雄。")
                -- self.RoleWindow.texts[0].text = "未选择英雄"
            end
        end
    )
    -- 返回按钮
    self.RoleWindow.buttons[1].transform:Find("Text (TMP)"):GetComponent("TextMeshProUGUI").text = "返回"
    self.RoleWindow.buttons[1].onClick:AddListener(
        function()
            CS.UnityEngine.Object.Destroy(self.RoleWindow.gameObject)
        end
    )

    local _herosList = {}
    local _
    if self.Tag == Tag1 then
        _, _, _herosList = StaticDataModel:ScreenList(PlayerDataModel.CompletePlayerData.Heros, "InsBuff", 1, "2")
    elseif self.Tag == Tag2 then
        _, _, _herosList = StaticDataModel:ScreenList(PlayerDataModel.CompletePlayerData.Heros, "InsBuff", 1, "3")
    elseif self.Tag == Tag3 then
        _, _, _herosList = StaticDataModel:ScreenList(PlayerDataModel.CompletePlayerData.Heros, "InsBuff", 1, "4", "5", "6", "7", "8", "9")
    end
    _ = nil

    
    -- 对英雄列表进行排序
    -- StaticDataModel:Sort(_herosList, "InsBuff", "1????")

    self:ShowHeroCells(_herosList)
end


-- 判断此道具目前是否可合成
-- 参数1(string)：需要进行判断的合成物ID
local function CheckCouldSyn(synItemID)
    -- 最终结果
    local result = false

    -- 遍历静态策划表，获取此装备合成所需的道具列表
    local _needsList = nil
    for _, v in pairs(StaticDataModel.ItemsTable) do
        if v.ItemID == synItemID then
            _needsList = ModelTool:SplitStr(v.SynNeeds)
            break
        end
    end

    if _needsList == nil then
        print("_needsList为空，未得到合成此道具所需的物品")
        return
    end

    -- 匹配数 满足一个条件+1
    local rightCount = 0
    -- 遍历所需物品(由于SynNeeds的格式为ID,C,ID,C,ID,C，所以需要除以2)
    for i = 1, #(_needsList) / 2, 1 do
        -- 遍历玩家目前的所有道具
        for k, v in pairs(PlayerDataModel.PlayerData.Items) do
            -- 如果ID匹配，且数量满足
            if v.ItemID == _needsList[2 * i - 1] and tonumber(v.Count) >= tonumber(_needsList[2 * i]) then
                -- 匹配数+1
                rightCount = rightCount + 1
            end
        end
    end

    -- print("rightCount:" .. rightCount)
    -- 匹配数满足，则true
    if rightCount == #(_needsList) / 2 then
        result = true
    end

    return result
end


--[[
    @desc: 检查所有道具，修改它的属性（是否可以合成）
    author:{author}
    time:2019-08-07 20:56:57
    --@items: 筛选过后 当前所有所需显示的道具表
]]
function MakerCtrl:CheckAllSyn(items)
    for k, v in pairs(items) do
        items[k].CouldSyn = tostring(CheckCouldSyn(v.ItemID))
    end
end

--[[
    @desc: 依序显示当前条件下的所有道具
    author:{author}
    time:2019-08-12 14:31:11
]]
function MakerCtrl:ShowItems()
    -- 删除所有子物体
    LoadManager:DeleteAllChilds(self.RightContent)
    self.ItemsNow = {}

    -- 筛选符合条件的道具
    local items = {}
    local _ = nil
    if self.Tag == Tag1 then
        items,_,_ = StaticDataModel:ScreenList(StaticDataModel.ItemsTable, "Type", 1, "2")
    elseif self.Tag == Tag2 then
        items,_,_ = StaticDataModel:ScreenList(StaticDataModel.ItemsTable, "Type", 1, "3")
    elseif self.Tag == Tag3 then
        items,_,_ = StaticDataModel:ScreenList(StaticDataModel.ItemsTable, "Type", 1, "4","5","6","7","8","9")
    end
    _ = nil

    -- 判断是否可合成
    self:CheckAllSyn(items)

    -- 对道具列表进行排序
    StaticDataModel:Sort(items, "CouldSyn", "true", self.SortWay, self.ChangeWay)

    -- 已经排好序的道具列表
    --ModelTool:SetMeta(items)
    --print(items)

    -- 生成Cell
    for k, v in pairs(items) do
        -- 加载并实例化
        local go = ABManager:LoadAsset("prefab", "Button")
        self.ItemsNow[k] = {}
        self.ItemsNow[k].obj = LoadManager:Load(go, self.RightContent.transform, true)
        self.ItemsNow[k].data = v
        -- 添加事件
        self.ItemsNow[k].obj:GetComponent("Button").onClick:AddListener(
            function()
                self.ItemChoice = self.ItemsNow[k].data
                ModelTool:SetMeta(self.ItemChoice)
                -- 打印数据
                print(self.ItemChoice)
                self:ShowSynNeeds()
                if v.CouldSyn == "true" then
                    self.Panel.buttons[1].interactable = true
                else
                    self.Panel.buttons[1].interactable = false
                end
            end
        )
        -- 显示图片
        self.ItemsNow[k].obj:GetComponent("Image").sprite = ABManager:LoadAsset("texture", items[k].TexturePath , CS.UnityEngine.Sprite)
        if items[k].CouldSyn == true then
            -- 不可合成的物品的图片显示
            self.ItemsNow[k].obj:GetComponent("Image").color = CS.UnityEngine.Color(0,0,1,1)
        end
        -- 不用显示数据
        self.ItemsNow[k].obj.transform:Find("Text"):GetComponent("Text").text = ""
    end

    -- 显示合成所需 nil
    self:ShowSynNeeds()
end


--[[
    @desc: 选中某道具时，在界面左侧显示其合成所需
    author:{author}
    time:2019-08-12 14:31:28
    @return:
]]
function MakerCtrl:ShowSynNeeds()
    print("ShowSynNeeds is running")
    local _needsList = {}

    if self.ItemChoice == nil then
        for i = 1, 3, 1 do
            self.Panel.texts[i].text = ""
            self.Panel.images[i].sprite = nil -- ABManager:LoadAsset("texture", "空白图" , CS.UnityEngine.Sprite)
        end
        return
    end

    -- 获取合成所需(id,count,id,count,...)
    _needsList = ModelTool:SplitStr(self.ItemChoice.SynNeeds)
    print(self.ItemChoice.SynNeeds)

    for i = 1, 3, 1 do
        -- 如果有所需合成的道具
        if 2*i <= #_needsList then
            -- print("_needsList:" .. _needsList[2 * i - 1] .. "," .. _needsList[2 * i])
            -- 遍历玩家目前的所有道具
            for k, v in pairs(PlayerDataModel.CompletePlayerData.Items) do
                -- 如果ID匹配
                if v.ItemID == _needsList[2 * i - 1] then
                    -- 显示数量
                    self.Panel.texts[i].text = _needsList[2 * i] .. "/" .. v.Count
                    -- 显示图片
                    self.Panel.images[i].sprite = ABManager:LoadAsset("texture", v.TexturePath , CS.UnityEngine.Sprite)
                    -- 显示数量不够时的图片效果
                    if tonumber(v.Count) < tonumber(_needsList[2 * i]) then
                    end
                    break
                -- 如果ID匹配不到
                elseif k == #(PlayerDataModel.CompletePlayerData.Items) then
                    self.Panel.texts[i].text = _needsList[2 * i] .. "/0"
                    self.Panel.images[i].sprite = nil
                end
            end
        -- 如果不需要道具，显示空白
        else
            print("3：_needsList is nil")
            self.Panel.texts[i].text = ""
            self.Panel.images[i].sprite = nil
        end
    end

    
    if self.ItemChoice ~=nil and self.ItemChoice.CouldSyn == "true" then
        self.Panel.buttons[1].interactable = true
    else
        self.Panel.buttons[1].interactable = false
    end

end


--[[
    @desc: 合成新的道具，扣除相应所需道具
    author:{author}
    time:2019-08-07 20:01:37
]]
function MakerCtrl:SynItem()
    local _needsList = ModelTool:SplitStr(self.ItemChoice.SynNeeds)

    -- 遍历所需物品(由于SynNeeds的格式为ID,C,ID,C,ID,C，所以需要除以2)
    for i = 1, #(_needsList) / 2, 1 do
        -- 遍历玩家目前的所有道具
        for k, v in pairs(PlayerDataModel.PlayerData.Items) do
            if v.ItemID == _needsList[2*i-1] then
                -- 扣除玩家表里相应的道具
                v.Count = tostring(tonumber(v.Count) - tonumber(_needsList[2 * i]))
                -- 如果道具数量为0，则去除此道具
                if v.Count == "0" then
                    PlayerDataModel.PlayerData.Items[k] = nil
                end
                break
            end
        end

        for k, v in pairs(PlayerDataModel.CompletePlayerData.Items) do
            if v.ItemID == _needsList[2*i-1] then
                -- 扣除玩家表里相应的道具
                v.Count = tostring(tonumber(v.Count) - tonumber(_needsList[2 * i]))
                -- 如果道具数量为0，则去除此道具
                if v.Count == "0" then
                    PlayerDataModel.CompletePlayerData.Items[k] = nil
                end
                break
            end
        end
    end

    -- 刷新界面
    self:ShowItems()
    
end


