RoleCtrl = {}

-- 预制体上的UISubObject脚本，内含所有UI对象
RoleCtrl.Panel = nil
RoleCtrl.LevelWindow = nil
-- 当前选择的角色在子物体中的Index
-- RoleCtrl.currentIndex = -1
-- 当前选择的角色数据
RoleCtrl.CurrentHero = nil
 
RoleCtrl.RoleSelectAniCSharp = nil

function RoleCtrl:Init()
    print("进入角色管理")
    self.Panel = LoadManager:Load(ABManager:LoadAsset("prefab", "RoleManUI"), "UI", true):GetComponent("UISubObject")
    -- self.LevelWindow = self.Panel.go[3]:GetComponent("UISubObject")

    -- 添加委托
    -- 返回按钮
    self.Panel.buttons[0].onClick:AddListener(
        function()
            UICtrl:Back2MainScene()
        end
    )
    -- 升级按钮
    self.Panel.buttons[1].onClick:AddListener(
        function()
            self.Panel.go[3]:SetActive(true)
            LevelCtrl:ShowLevelInfo(self.CurrentHero)
        end
    )
    -- 详情按钮
    self.Panel.buttons[2].onClick:AddListener(
        function()
            self.Panel.go[8]:SetActive(true)
            self.Panel.go[4]:SetActive(true)
            DetailCtrl:ShowDetailInfo(self.CurrentHero)
            -- ModelTool:SetMeta(self.CurrentHero)
            -- print(self.CurrentHero)
        end
    )

    LoadManager:LoadLua("Role", "RoleView")
    LoadManager:LoadLua("Role", "LevelCtrl")
    LevelCtrl:Init()
    LoadManager:LoadLua("Role", "DetailCtrl")
    DetailCtrl:Init()

    -- 按ID排序 可在每次抽卡后就进行排序
    StaticDataModel:SortHeroByHeroID(PlayerDataModel.CompletePlayerData.Heros)
    -- 调取View 加载显示英雄列表
    RoleView:ShowHerosList(PlayerDataModel.CompletePlayerData.Heros)

    -- 英雄列表的Content上的动画CSharp脚本
    self.RoleSelectAniCSharp = self.Panel.go[2]:GetComponent("RolePanelSelectAnimation")
    self.RoleSelectAniCSharp:Init()
    self.RoleSelectAniCSharp.changeRoleEvent = function() self:ChangeCurrentRole() end

    -- 切换当前英雄为列表第一个
    self:ChangeCurrentRole()

end


-- 切换英雄
function RoleCtrl:ChangeCurrentRole()
    self.CurrentHero = ModelTool:CopyTable( PlayerDataModel.CompletePlayerData.Heros[self.RoleSelectAniCSharp.currentRoleID + 1] )
    -- print(PlayerDataModel.CompletePlayerData.Heros[self.RoleSelectAniCSharp.currentRoleID + 1].Equips)
    print("当前角色改变为：" .. self.RoleSelectAniCSharp.currentRoleID + 1)
    RoleView:ShowHeroInfo(self.CurrentHero)
end




-- 投喂英雄
function RoleCtrl:FeedHero(heroData, itemData, count)
    -- 处理数据：将食物Buff附加给英雄Buff
    local _hbuffT = ModelTool:SplitStr(heroData.ColBuffAdd)
    local _ibuff = ModelTool:SplitStr(itemData.HeroBuff)
    -- 如果英雄当前的临时Buff 小于 道具的加成Buff，进行赋值
    if _hbuffT[1] < _ibuff[3] then
        _hbuffT[1] = _ibuff[3]
    end
    if _hbuffT[2] < _ibuff[4] then
        _hbuffT[2] = _ibuff[4]
    end

    -- 修改 玩家动态数据 里相应的英雄信息
    for k, v in pairs(PlayerDataModel.PlayerData.Heros) do
        -- 找到相应英雄
        if v.HeroID == heroData.HeroID then
            -- 赋值给英雄
            v.ColBuffAdd = _hbuffT[1] .. "," .. _hbuffT[2]
            v.EnergyNow = tostring(tonumber(v.EnergyNow) + _ibuff[2]*count)
            if tonumber(v.EnergyNow) > tonumber(v.EnergyMax) then
                v.EnergyNow = v.EnergyMax
            end
            break
        end
    end

    -- 修改 玩家动态数据 里相应的英雄信息
    for k, v in pairs(PlayerDataModel.CompletePlayerData.Heros) do
        -- 找到相应英雄
        if v.HeroID == heroData.HeroID then
            -- 赋值给英雄
            v.ColBuffAdd = _hbuffT[1] .. "," .. _hbuffT[2]
            v.EnergyNow = tostring(tonumber(v.EnergyNow) + _ibuff[2]*count)
            if tonumber(v.EnergyNow) > tonumber(v.EnergyMax) then
                v.EnergyNow = v.EnergyMax
            end

            heroData = ModelTool:CopyTable(PlayerDataModel.CompletePlayerData.Heros[k])
            break
        end
    end
    
    return heroData
end
